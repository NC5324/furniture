<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;

            font-family: 'Open Sans', 'Arial', sans-serif;
        }
        details {
            font-family: 'Open Sans', 'Arial', sans-serif;
            font-size: 22px;
            color: #001F23;
            padding-left: 30px;

            cursor: pointer;
            position: relative;
        }
        details > summary {
            list-style-type: none;
            position: relative;
        }

        details > summary::after {
            content: attr(data-after-closed);
            position: absolute;
            right: 0;
            top: 0;
        }

        details[open] > summary::after {
            content: attr(data-after-open);
        }

        details > summary:focus {
            outline: none
        }

        #categories {
            flex: 0 1 500px;
            margin-right: 1%;

            position: -webkit-sticky;
            position: sticky;
            top: 0;
            left: 0;
        }

        .browse {
            flex: 1 1 auto;
            margin: 20px 1% 1%;

            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            grid-gap: 20px;
            align-items: stretch;
        }

        .item {
            background-color: white;
            height: 350px;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 6px 0px  rgba(0,0,0,0.3);

            cursor: pointer;
            display: flex;
            flex-flow: column nowrap;
        }

        .item-thumb {
            flex: 0 0 250px;
            background-color: lightcoral;
            background-size: cover;
            background-position: center bottom;
        }

        .item-footer {
            flex: 1 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;

            transition: background-color 0.9s ease-out;
        }

        .item h2 {
            color: #001F23;
        }

        .item:hover .item-footer {
            background: #001F23;
        }

        .item:hover h2 {
            color: white;
        }

        /*details::before {
            display: inline-block;
            content: "";
            position: absolute;
            top: -3px;
            left: 5px;
            bottom: -3px;
            width: 2px;
            background-color: #001F23;
        }*/
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        class Category {
            constructor(parentId, id, lvl, title) {
                this.parentId = parentId
                this.id = id
                this.lvl = lvl
                this.title = title
            }
        }

        // mock categories for testing purposes
        const categories = [
            new Category(null, 1, 0, 'Холна гарнитура'),
            new Category(1, 2, 1, 'Дивани'),
            new Category(1, 3, 1, 'Фотьойли'),
            new Category(1, 4, 1, 'Холни маси'),
            new Category(2, 5, 2, 'Разтегателни дивани'),
            new Category(2, 6, 2, 'Ъглови дивани'),
            new Category(null, 7, 0, 'Спалня'),
            new Category(null, 8, 0, 'Кухня'),
            new Category(7, 9, 1, 'Легла'),
            new Category(7, 10, 1, 'Нощни шкафчета'),
            new Category(7, 11, 1, 'Ракли')
        ]

        // mock products for testing purposes
        const products = [
            {
                name: 'Холна гарнитура BOSNA',
                thumbnail: 'assets/divan1.jpg',
                category: 2
            },
            {
                name: 'Холна гарнитура DESTAN',
                thumbnail: 'assets/divan2.jpg',
                category: 2
            },
            {
                name: 'Холна гарнитура LUXURY',
                thumbnail: 'assets/divan3.jpg',
                category: 2
            },
            {
                name: 'Холна гарнитура ESH N SIQUE',
                thumbnail: 'assets/02.jpg',
                category: 2
            },
            {
                name: 'Легло',
                thumbnail: 'assets/02.jpg',
                category: 9
            }]

        // self-explanatory, moved into a function for better code readability
        function createCheckBox(ctgId) {
            const check = document.createElement('input')
            check.setAttribute('id', 'ctg-'+ctgId)
            check.setAttribute('type', 'checkbox')
            check.style.marginRight = '10px'

            return check
        }

        $(document).ready(() => {
            console.log('Document is fully loaded.')
            let selected = []
            let items = products

            // populate the browsing section when there is a change in selected filters
            const filterEvent = new Event('filter')
            document.addEventListener('filter', () => {
                $('.browse').empty()
                const template = document.querySelector('#item')
                for(let i=0; i<items.length; i++) {
                    const clone = template.content.cloneNode(true)
                    clone.querySelector('.item-footer h2').textContent = items[i].name
                    document.querySelector('.browse').appendChild(clone);
                }
            })

            // initialize browsing section
            document.dispatchEvent(filterEvent)

            // script for generating nested categories using the category template
            const maxLvl = Math.max.apply(Math, categories.map(x => x.lvl))
            for(let level = 0; level <= maxLvl; level++) {
                const ctgs = categories.filter(category => category.lvl === level)
                for(let ctg = 0; ctg < ctgs.length; ctg++) {
                    const container = !ctgs[ctg].parentId ?
                        document.querySelector('#categories') :
                        document.querySelector(`details[data-id='${ctgs[ctg].parentId}']`)

                    const clone = document.querySelector('#category').content.cloneNode(true)
                    clone.querySelector('details').setAttribute('data-id', ctgs[ctg].id + '')

                    const summary = clone.querySelector('summary')
                    const checkBox = createCheckBox(ctgs[ctg].id)

                    // remove expand icons if no children categories
                    const children = categories.filter(x => x.lvl > ctgs[ctg].lvl && x.parentId === ctgs[ctg].id)
                    if(children.length === 0) {
                        clone.querySelector(`details[data-id="${ctgs[ctg].id}"] summary`).setAttribute('data-after-closed', '')
                        clone.querySelector(`details[data-id="${ctgs[ctg].id}"] summary`).setAttribute('data-after-open', '')
                    }

                    // select children categories on category selection
                    // fire an event for filtering
                    $(checkBox).change(() => {
                        children.forEach(x => {
                            $('#ctg-' + x.id).click()
                        })

                        selected = Array.from(document.querySelectorAll('input[type="checkbox"]')).filter(x => x.checked).map(x => Number(x.id.split('-')[1]))
                        items = selected.length === 0 ? products : products.filter(x => selected.includes(x.category))

                        document.dispatchEvent(filterEvent)
                    })

                    const title = document.createTextNode(ctgs[ctg].title);
                    summary.append(checkBox, title)
                    container.appendChild(clone)
                }
            }
        })
    </script>
</head>
<body>
<template id="category">
    <details open style="margin-bottom: 5px; margin-top: 5px">
        <summary data-after-closed="►" data-after-open="▼"></summary>
    </details>
</template>
<template id="item">
    <article class="item">
        <div class="item-thumb">
        </div>
        <div class="item-footer">
            <h2>Име на продукт</h2>
        </div>
    </article>
</template>
<div class="wrapper" style="min-width: 100%; min-height: 100vh; display: flex; padding: 60px; position: relative">
    <div id="categories" style="margin-top: 20px">

    </div>
    <div class="browse">

    </div>
</div>
</body>
</html>
